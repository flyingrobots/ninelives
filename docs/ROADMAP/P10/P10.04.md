---
id: P10.04
title: Production Observability
estimate: 8h
status: blocked
blocked_by:
- P10.03
blocks:
- P10.03
- P1.09
- P7.02
value: M
---
# [P10.04] Production Observability

## Summary

Enhance `ninelives` with detailed tracing spans and integrate with standard metrics systems (e.g., Prometheus) to provide deep insights into policy behavior and system health in production environments.

## Context

Effective monitoring and debugging are essential for production systems. `ninelives` policies, especially adaptive and self-healing ones, generate rich telemetry. This task ensures that this telemetry is easily consumable by operators and existing observability stacks.

## Design
- **Detailed Tracing**:
    - Add `tracing` spans to all `ninelives` layers (`RetryLayer`, `CircuitBreakerLayer`, `BulkheadLayer`, `TimeoutLayer`, `ForkJoinLayer`, `ShadowLayer`).
    - Spans should capture key events (e.g., circuit state change, retry attempt, request cancellation) and relevant metadata.
- **Metrics Integration**:
    - Implement a `TelemetrySink` (P1.09) that pushes aggregated metrics (from P3.02) to Prometheus (via `prometheus-client` or `opentelemetry-prometheus`).
    - Expose `Adaptive<T>` values (from P2.09) as Prometheus gauges.
- **Flame Graph Support**:
    - Ensure easy generation of flame graphs for production binaries, aiding in performance debugging.

## Definition of Done
- [ ] All `ninelives` layers emit rich `tracing` spans.
- [ ] `ninelives-metrics-prometheus` crate (or similar) implemented as a `TelemetrySink`.
- [ ] Key `Adaptive<T>` values are exposed as Prometheus metrics.
- [ ] Clear instructions for generating flame graphs in `docs/` or `xtask`.

## Test Plan

### Integration Tests
- [ ] **Tracing**: Run a `ninelives` application with a `tracing-subscriber` and verify expected spans are emitted.
- [ ] **Metrics**: Run a `ninelives` application with Prometheus integration, hit a test endpoint, and verify metrics show up in Prometheus.

### Manual Verification
- [ ] Deploy a sample application with tracing and metrics; visually inspect logs and Prometheus dashboard for completeness.
- [ ] Generate a flame graph from a running process and verify it provides useful insights.

## Dependencies
- **Requires**: P10.03 (Advanced Reliability Testing - to generate load for metrics/tracing), P1.09 (Telemetry Sinks), P7.02 (Crate Split for metrics crate).