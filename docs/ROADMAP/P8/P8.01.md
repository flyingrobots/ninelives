---
id: P8.01
title: Command Serialization & Deserialization
estimate: 6h
status: open
blocked_by: []
blocks:
- P8.04
- P8.03
- P7.02
- P8.02
- P2.14b
value: H
---
# [P8.01] Command Serialization & Deserialization

## Summary

Design and implement transport-agnostic command serialization and deserialization. This involves defining the wire format for `CommandEnvelope` and its contents (especially `BuiltInCommand` and `AuthPayload`), and providing utility functions or traits for converting to/from common formats like JSON.

## Context

The `CommandRouter` operates on a Rust-native `CommandEnvelope<C>`. To expose this via various network protocols (HTTP, gRPC), we need a standardized way to convert this structure to a byte stream and back. This builds directly on `P2.14`'s `Transport` abstraction.

## Design
- **Wire Format**: Canonical JSON will be the primary wire format, specified via `serde_json::Value`.
- **Serialization Logic**: Utility functions or traits (`SerializeCommand`, `DeserializeCommand`) that handle conversion from `CommandEnvelope` to `serde_json::Value` and vice-versa, including mapping `AuthPayload` variants.
- **Error Handling**: Robust error mapping for malformed requests or unsupported command types.

## Definition of Done
- [ ] Clear specification of the canonical JSON wire format for commands and responses (e.g., in `docs/ADR-008-command-wire-format.md`).
- [ ] Utility functions/traits for `CommandEnvelope` <-> `serde_json::Value` conversion.
- [ ] Unit tests for round-trip serialization/deserialization of various command types.

## Test Plan

### Unit Tests
- [ ] **BuiltInCommand**: Test serialization/deserialization of all `BuiltInCommand` variants.
- [ ] **AuthPayload**: Test serialization/deserialization of different `AuthPayload` types (JWT, MTLS, Opaque).
- [ ] **Malformed Input**: Verify deserialization gracefully handles invalid JSON or missing fields.

### Integration Tests
- [ ] Use a mock `Transport` (from P2.14) to pass `serde_json::Value` and verify it correctly converts to/from `CommandEnvelope`.

## Dependencies
- **Requires**: P2.14 (Transport Abstraction Design), P7.02 (ninelives-control crate).
- **Enables**: P8.02 (HTTP REST Transport), P8.03 (gRPC Transport).