---
id: P6.03
title: Shadow Promotion & Management
estimate: 8h
status: blocked
blocked_by:
- P6.02
blocks:
- P5.03c
- P2.19
- P6.04
- P2.09
value: H
---
# [P6.03] Shadow Promotion & Management

## Summary

Implement the logic within `ninelives-sentinel` (from P5) to observe shadow policy performance, automatically promote stable shadow configurations to primary, and provide control plane commands for manual promotion/rollback.

## Context

The ultimate goal of shadowing is to safely validate and then activate new policies. This requires automated analysis of shadow metrics and an atomic swap mechanism to transition from shadow to primary.

## Design
- **Sentinel Meta-Policy**: A new meta-policy script (P5.04) that:
    1. Periodically queries `TelemetryAggregator` for primary and shadow metrics (P6.02).
    2. Evaluates criteria for stability and improvement (e.g., "shadow error rate < primary error rate for 1 hour").
    3. If criteria met, issues a `PromoteShadowHandler` command.
- **`PromoteShadowHandler` Command**: A new control plane command (P2.19) that:
    - Atomically swaps the `shadow` value to `primary` in targeted `Adaptive<T>` handles.
    - Clears the `shadow` value.
- **Safety**: Ensure the promotion is atomic and can be rolled back if issues arise. Implement a "circuit breaker" on promotion itself.

## Definition of Done
- [ ] `PromoteShadowHandler` command implemented and integrated into the `CommandRouter`.
- [ ] Atomic swap mechanism for `Adaptive<T>` shadow to primary.
- [ ] A new Sentinel meta-policy (in P5.04) that observes shadow metrics and triggers promotion.
- [ ] Unit tests for atomic swap and promotion command.

## Test Plan

### Unit Tests
- [ ] **Atomic Swap**: Test `Adaptive<T>::promote_shadow()`: verifies primary is updated, shadow is cleared.
- [ ] **Promotion Command**: Test `PromoteShadowHandler` with mock `Adaptive<T>` handles.

### Integration Tests
- [ ] **Full Cycle**:
    1. Start a `ShadowLayer` with a degraded primary and improved shadow policy.
    2. Start `Sentinel` with the promotion meta-policy.
    3. Verify that after metrics stabilize, the shadow is automatically promoted to primary.
- [ ] **Manual Rollback**: Send a `RollbackShadowHandler` (or `WriteConfig` to primary) command to verify manual override.

## Dependencies
- **Requires**: P6.02 (Shadow Telemetry), P5.03 (Sentinel evaluation loop), P2.19 (Control Plane for commands), P2.09 (Adaptive config).
- **Enables**: P6.04 (Safety documentation).