---
id: P6.02
title: Shadow Telemetry & Observer Integration
estimate: 6h
status: blocked
blocked_by:
- P6.01
- P9.01
blocks:
- P6.03
- P3.02b
value: H
---
# [P6.02] Shadow Telemetry & Observer Integration

## Summary

Define a `ShadowEvent` to capture results from shadow policy executions and integrate these events into the `TelemetryAggregator` (from P3.02) for separate analysis.

## Context

To assess the effectiveness and safety of a shadowed policy, its performance must be observable and directly comparable to the primary. This requires distinct telemetry events and separate aggregation in the Observer.

## Design
- **`ShadowEvent`**: A new `PolicyEvent` variant or a wrapper struct that includes both the `PolicyEvent` from the shadow execution and metadata indicating its shadow nature.
- **`ShadowLayer` Event Emission**: The `ShadowLayer` (from P6.01) must emit `ShadowEvent`s that capture the outcome of the shadow service (success, failure, latency, etc.).
- **`TelemetryAggregator` Handling**: The `TelemetryAggregator` (P3.02) needs to distinguish between primary and shadow events and aggregate them into separate `WindowedMetrics` buckets (e.g., `metrics["my-service-primary"]` vs `metrics["my-service-shadow"]`).
- **`SystemState` Query**: The `SystemState` query interface (P3.06) needs to expose both primary and shadow metrics.

## Definition of Done
- [ ] `ShadowEvent` type defined within `PolicyEvent` or as a distinct, related struct.
- [ ] `ShadowLayer` emits `ShadowEvent`s for each shadow request.
- [ ] `TelemetryAggregator` correctly separates and aggregates primary and shadow metrics.
- [ ] `SystemState` query can retrieve both primary and shadow metrics.

## Test Plan

### Unit Tests
- [ ] **Event Distinction**: Verify `TelemetryAggregator` correctly routes `PolicyEvent` vs `ShadowEvent` to different metric stores.
- [ ] **Metadata Propagation**: Ensure `ShadowEvent` contains all necessary context for analysis.

### Integration Tests
- [ ] Run a `ShadowLayer` with a primary and shadow service, pump traffic, and verify `TelemetryAggregator` shows distinct and accurate metrics for both.
- [ ] Query `SystemState` (P3.06) and confirm both sets of metrics are available.

## Dependencies
- **Requires**: P6.01 (Shadow Layer), P3.02 (Telemetry Aggregator) for ingestion.
- **Enables**: P6.03 (Shadow Promotion Logic).