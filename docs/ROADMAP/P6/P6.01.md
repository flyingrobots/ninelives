---
id: P6.01
title: Shadow Layer & Adaptive Support
estimate: 10h
status: blocked
blocked_by:
- P9.01
blocks:
- P2.19
- P6.02
- P2.09
value: H
---
# [P6.01] Shadow Layer & Adaptive Support

## Summary

Implement a `ShadowLayer` that duplicates incoming requests and sends one to the primary service and one to a shadow service configured with a different adaptive policy. This task also includes extending `Adaptive<T>` to support "shadow" values and implementing a kill-switch for expensive shadow evaluation.

## Context

"Shadowing" allows for A/B testing new policies or configurations in production with real traffic without affecting the primary path. The challenge is to isolate performance and prevent resource exhaustion.

## Design
- **`ShadowLayer`**:
    - Wraps a primary service and a shadow service.
    - Clones the request.
    - Dispatches one request to primary, one to shadow.
    - Returns primary's response.
    - Shadow response (and any errors/events) are emitted via telemetry.
- **`Adaptive<T>` Shadow Values**:
    - Allow an `Adaptive<T>` handle to store a `primary` and a `shadow` value.
    - Shadowed policies use the `shadow` value.
- **Performance Isolation**:
    - Shadow requests run on a separate `tokio::task::LocalSet` or `spawn_blocking` if CPU-bound.
    - Shadow service should have a `BulkheadLayer` (P2.04) and `CircuitBreakerLayer` (P2.03) with aggressive settings (`P6.10.a/b`) to prevent shadow overload from affecting primary.
    - Shadow evaluation must not add significant latency to the primary path.

## Definition of Done
- [ ] `ShadowLayer` implemented, routing to primary and shadow services.
- [ ] `Adaptive<T>` supports `primary` and `shadow` values with an API to select which one to use.
- [ ] Shadow requests run in a non-blocking/isolated manner.
- [ ] Unit tests for request cloning, response handling, and performance isolation.

## Test Plan

### Unit Tests
- [ ] **Request Cloning**: Verify the shadow service receives an identical request.
- [ ] **Primary Response**: Ensure `ShadowLayer` always returns the primary service's response.
- [ ] **Shadow Execution**: Confirm the shadow service is invoked.
- [ ] **Latency Impact**: Benchmark `ShadowLayer` overhead to primary path, confirming it's minimal.

### Integration Tests
- [ ] Wrap a `RetryLayer` with different `Adaptive<usize>` `max_attempts` for primary/shadow. Verify shadow behavior.

## Dependencies
- **Requires**: P2.09 (Control Plane), P2.19 (Built-in commands like WriteConfig to tune adaptive values).
- **Enables**: P6.02 (Telemetry for shadow events).