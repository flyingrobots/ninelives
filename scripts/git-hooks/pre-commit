#!/usr/bin/env bash
set -Eeuo pipefail

# Ensure the repository is using the expected hooks path. This catches cases
# where contributors forget to run ./scripts/setup-hooks.sh after cloning.
HOOKS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
CONFIGURED_PATH="$(git config --get core.hooksPath || true)"
if [ -n "$CONFIGURED_PATH" ]; then
  CONFIGURED_PATH="$(cd "$CONFIGURED_PATH" 2>/dev/null && pwd -P || true)"
fi

if [ "$CONFIGURED_PATH" != "$HOOKS_DIR" ]; then
  echo "[pre-commit] core.hooksPath is not set to $HOOKS_DIR" >&2
  echo "[pre-commit] Run ./scripts/setup-hooks.sh to install the hooks." >&2
  exit 1
fi
# Verify rustfmt is installed
if ! command -v rustfmt &> /dev/null; then
  echo "Error: rustfmt not found. Install with: rustup component add rustfmt" >&2
  exit 1
fi

# Stash unstaged changes to test only what's being committed
STASH_NAME="pre-commit-$(date +%s)"
git stash push --quiet --keep-index --include-untracked -m "$STASH_NAME"

# Ensure stash is popped on exit
trap 'git stash pop --quiet 2>/dev/null || true' EXIT

echo "[pre-commit] running markdownlint (npm run lint:md:fix)"
if ! npm run --silent lint:md:fix; then
  echo "Error: markdownlint reported issues. Run 'npm ci' then retry or fix lint errors." >&2
  exit 1
fi

# Re-stage markdown files if autofixed
changed_md=$(git diff --name-only -- '*.md')
if [ -n "$changed_md" ]; then
  git add $changed_md
fi

echo "[pre-commit] running cargo fmt -- --check"
if ! cargo fmt --color=always -- --check; then
  echo "Error: Code formatting issues detected. Run 'cargo fmt' to fix." >&2
  exit 1
fi

echo "[pre-commit] running cargo clippy --all-targets --all-features -- -D warnings -D missing_docs"
if ! cargo clippy --all-targets --all-features -- -D warnings -D missing_docs; then
  status=$?
  echo "Error: cargo clippy failed with exit code $status." >&2
  exit $status
fi

echo "[pre-commit] all checks passed"
