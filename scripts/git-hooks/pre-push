#!/usr/bin/env bash
set -euo pipefail

echo "[pre-push] running cargo fmt -- --check"
cargo fmt -- --check

echo "[pre-push] running markdownlint-cli2"
npx markdownlint-cli2 "**/*.md"

echo "[pre-push] running cargo clippy --all-targets --all-features -- -D warnings -D missing_docs"
cargo clippy --all-targets --all-features -- -D warnings -D missing_docs

echo "[pre-push] running cargo test --all-features --all-targets"
cargo test --all-features --all-targets

echo "[pre-push] running cargo doc --no-deps with -D warnings"
RUSTDOCFLAGS="-D warnings" cargo doc --no-deps

echo "[pre-push] syncing roadmap DAG (cargo run -p xtask --bin xtask sync-dag all)"
cargo run -p xtask --bin xtask sync-dag all || {
  echo "[pre-push] xtask sync-dag failed; aborting push" >&2
  exit 1
}

if [ ! -s docs/ROADMAP ]; then
  echo "[pre-push] docs/ROADMAP missing or empty after sync" >&2
  exit 1
}

echo "[pre-push] checking for roadmap drift against HEAD"
git diff --exit-code HEAD docs/ROADMAP || {
  echo "[pre-push] roadmap drift detected; run 'cargo run -p xtask --bin xtask sync-dag all' and commit" >&2
  exit 1
}

echo "[pre-push] all checks passed"
