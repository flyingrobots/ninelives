name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.event.number || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  actionlint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.6
      - name: Lint workflows
        uses: rhysd/actionlint@v1.7.4

  commit-policy:
    needs: actionlint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.6
        with:
          fetch-depth: 0
      - name: Determine base ref
        id: base
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ref=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          else
            echo "ref=origin/main" >> $GITHUB_OUTPUT
          fi
      - name: Inspect commit message
        id: msg
        run: |
          msg=$(git log -1 --pretty=%s)
          echo "msg=$msg" >> $GITHUB_OUTPUT
          echo "Commit message: $msg"
      - name: Ensure feat/fix add tests
        if: startsWith(steps.msg.outputs.msg, 'feat') || startsWith(steps.msg.outputs.msg, 'fix')
        run: |
          git fetch origin ${{ steps.base.outputs.ref }} --quiet
          files=$(git diff --name-only ${{ steps.base.outputs.ref }}...HEAD)
          if echo "$files" | grep -E '(tests?/|_test\\.rs|tests\\.rs)' >/dev/null; then
            echo "Tests detected in diff"
          else
            echo "error: feat/fix commits must add or modify tests" >&2
            exit 1
          fi
      - name: Coverage guard for chore/refactor
        if: startsWith(steps.msg.outputs.msg, 'chore') || startsWith(steps.msg.outputs.msg, 'refactor')
        run: |
          sudo apt-get update >/dev/null && sudo apt-get install -y jq >/dev/null
          cargo install cargo-llvm-cov --locked --version 0.6.21
          git fetch origin ${{ steps.base.outputs.ref }} --quiet
          git worktree add /tmp/base ${{ steps.base.outputs.ref }}
          run_cov() {
            dir=$1
            pushd "$dir" >/dev/null
            cargo llvm-cov --workspace --all-features \
              --exclude xtask --exclude ninelives-nats --exclude ninelives-kafka \
              --exclude ninelives-elastic --exclude ninelives-etcd --exclude ninelives-otlp \
              --exclude ninelives-prometheus --exclude ninelives-jsonl \
              --summary-only --json > /tmp/cov.json
            jq -r '.line.percent' /tmp/cov.json
            popd >/dev/null
          }
          base_cov=$(run_cov /tmp/base)
          head_cov=$(run_cov .)
          echo "base coverage: $base_cov"
          echo "head coverage: $head_cov"

          # Format floats to 2 decimal places for consistent parsing
          bcov=$(printf '%.2f' "$base_cov")
          hcov=$(printf '%.2f' "$head_cov")

          # If parsing failed, exit with an error.
          if [ -z "$bcov" ] || [ -z "$hcov" ]; then
            echo "error: Failed to parse coverage output. Base: '$base_cov', Head: '$head_cov'." >&2
            exit 1
          fi

          # Perform integer-based comparison on whole percentages (rounded)
          b_int=$(awk -v val="$bcov" 'BEGIN { print int(val + 0.5) }') # Round to nearest integer
          h_int=$(awk -v val="$hcov" 'BEGIN { print int(val + 0.5) }') # Round to nearest integer

          echo "Base coverage (rounded %): $b_int"
          echo "Head coverage (rounded %): $h_int"

          if [ "$h_int" -lt "$b_int" ]; then
            echo "error: Coverage decreased (Base: $b_int% -> Head: $h_int%)." >&2
            exit 1
          fi

      - name: Clean worktree
        if: always()
        run: git worktree prune

  fmt-clippy-test:
    needs: actionlint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.6
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.82.0
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2.7.3
      - name: Format check
        run: cargo fmt -- --check
      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings -D missing_docs
      - name: Tests (all features)
        run: cargo test --all-features --all-targets

  # Integration tests have been moved to .github/workflows/integration-tests.yml
  # to reduce duplication and improve maintainability.

  msrv:
    needs: actionlint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.6
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.70.0
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2.7.3
      - name: Tests on MSRV
        run: cargo test --all-features --all-targets

  docs:
    needs: actionlint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.6
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.82.0
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2.7.3
      - name: Docs
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: cargo doc --no-deps

  coverage:
    needs: fmt-clippy-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.1.6
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.82.0
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2.7.3
      - name: Coverage (fail under 80%)
        run: >
          cargo llvm-cov -p ninelives --all-features
          --fail-under-lines 80 --summary-only
